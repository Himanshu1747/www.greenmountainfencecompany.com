---
import { queryWordPress } from "../lib/wordpress";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Excellence from "../components/Excellence.astro";
import Testimonial from "../components/Testimonial.astro";
import Tipsfaq from "../components/Tipsfaq.astro";
import Footer from "../components/Footer.astro";

/** * HIGH SPEED CACHING STRATEGY
 * s-maxage=1: Cache is "fresh" for 1 second.
 * stale-while-revalidate=59: Serve old cache instantly while updating in background.
 */
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=120, stale-while-revalidate=30'
);

const QUERY_ABOUT = `
query Aboutpage {
  page(id: "about", idType: URI) {
    title
    seo { canonical cornerstone fullHead }
    featuredImage {
      node { 
        mediaItemUrl 
        altText 
        mediaDetails { width height }
      }
    }
    aboutUs {
      excellenceTitle
      video { node { mediaItemUrl } }
      videoPoster { node { mediaItemUrl } }
      aboutUsTitle
      aboutDesc
    }
  }
}`;

const pagedata = await queryWordPress(QUERY_ABOUT);
const finaldata = pagedata?.page || {};
const seodata = finaldata?.seo || {};
const aboutUs = finaldata?.aboutUs || {};

const bannerUrl = finaldata?.featuredImage?.node?.mediaItemUrl || "";
const bannerWidth = finaldata?.featuredImage?.node?.mediaDetails?.width || "1920";
const bannerHeight = finaldata?.featuredImage?.node?.mediaDetails?.height || "532";
const videoPosterUrl = aboutUs?.videoPoster?.node?.mediaItemUrl || "";
const videoUrl = aboutUs?.video?.node?.mediaItemUrl || "";
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead
            useYoast={true}
            canonical={seodata?.canonical || ""}
            focuskw={seodata?.focuskw || ""}
        />
        {seodata?.fullHead && <Fragment set:html={seodata.fullHead} />}
        
        {/* SPEED: Preload the Largest Contentful Paint (LCP) image immediately */}
        {bannerUrl && (
            <link rel="preload" as="image" href={bannerUrl} fetchpriority="high" />
        )}
    </head>
    <body>
        <Header />

        <main id="main-content">
            <section class="innerbanner-sec">
                <img
                    src={bannerUrl}
                    alt={finaldata?.featuredImage?.node?.altText || finaldata?.title || "About Banner"}
                    title={finaldata?.title || ""}
                    width={bannerWidth}
                    height={bannerHeight}
                    loading="eager" 
                    fetchpriority="high"
                    decoding="sync" 
                    class="banner-image"
                />
                <div class="container">
                    <div class="allabout-banner">
                        <h1 class="fs-80">{finaldata?.title || ""}</h1>
                    </div>
                </div>
            </section>

            <section class="mainabout-sec">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-xl-6">
                            <div class="about-data">
                                <h2 class="fs-60">{aboutUs?.aboutUsTitle || ""}</h2>
                                <div set:html={aboutUs?.aboutDesc || ""} />
                            </div>
                        </div>
                        <div class="col-xl-6">
                            <div class="aboutvideo">
                                <video
                                    src={videoUrl}
                                    poster={videoPosterUrl}
                                    width="670"
                                    height="373"
                                    controls
                                    playsinline
                                    preload="none" 
                                    style="background-color: #000; display: block; width: 100%; height: auto;"></video>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="excellence-sec">
                <div class="container">
                    <div class="parent-excellence">
                        <div class="excelence-title">
                            <h2 class="fs-60 text-green">
                                {aboutUs?.excellenceTitle || ""}
                            </h2>
                        </div>
                        <Excellence />
                    </div>
                </div>
            </section>

            {/* SPEED: Only load Javascript for these when they are visible on screen */}
            <Testimonial client:visible />
            <Tipsfaq client:visible />
        </main>

        <Footer />

        <style is:inline>
            /* CSS remains identical to maintain your design while ensuring layout stability */
            .banner-image { 
                width: 100%; 
                height: auto; 
                aspect-ratio: 1920/532; 
                object-fit: cover; 
                display: block; 
            }
            .aboutvideo { 
                max-width: 670px; 
                overflow: hidden; 
                width: 100%; 
                margin-left: auto; 
                aspect-ratio: 670 / 373; 
                background: #f0f0f0;
            }
            .about-data { max-width: 775px; width: 100%; }
            section.mainabout-sec { padding: 130px 0px 50px 0px; }
            @media (max-width: 1600px) { section.mainabout-sec { padding: 70px 0px 20px 0px; } }
            @media (max-width: 1400px) { section.mainabout-sec { padding: 50px 0px 20px 0px; } .aboutvideo { margin: 0 auto; } }
            @media (max-width: 1199px) { .aboutvideo { padding-top: 30px; } section.mainabout-sec { padding: 40px 0px 20px 0px; } }
        </style>
    </body>
</html>