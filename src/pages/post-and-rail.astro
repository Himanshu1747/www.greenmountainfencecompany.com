---
import { queryWordPress } from "../lib/wordpress";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";

/** * HIGH SPEED CACHING STRATEGY
 * public, s-maxage=1, stale-while-revalidate=59
 * This ensures 0ms delivery from the edge while keeping data fresh.
 */
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=120, stale-while-revalidate=30'
);
const CEDARPAGE = `
query GetCedarWoodFence {
  page(id: "post-and-rail", idType: URI) {
    title
    seo {
      canonical
      cornerstone
      fullHead
    }
    featuredImage {
      node {
        mediaItemUrl
        altText
      }
    }
    cedarWoodFence {
      propertyTitle
      descrptionmain 
      galleryImage(first: 500) { 
        nodes {
          altText
          sourceUrl 
          mediaDetails {
            sizes {
              name  
              sourceUrl
              width
              height
            }
          }
        }
      }
      mainTitlegreen
      greendescription
      greenimage {
        node {
          mediaItemUrl
          altText
        }
      }
    }
  }
}
`;

const pagedata = await queryWordPress(CEDARPAGE);
const finaldata = pagedata?.page || {};
const seodata = finaldata?.seo || {};
const cedarData = finaldata?.cedarWoodFence || {};
const bannerUrl = finaldata?.featuredImage?.node?.mediaItemUrl || "";
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead
            useYoast={true}
            canonical={seodata?.canonical || ""}
            focuskw={seodata?.focuskw || ""}
        />
        {seodata?.fullHead && <Fragment set:html={seodata.fullHead} />}
        
        {/* SPEED: Preload LCP Banner immediately */}
        {bannerUrl && <link rel="preload" as="image" href={bannerUrl} fetchpriority="high" />}

        {/* GLightbox CSS - Added media print for non-blocking load if needed, but keeping your original link */}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
    </head>
    <body>
        <Header />

        <section class="innerbanner-sec">
            <img
                src={bannerUrl}
                alt={finaldata?.featuredImage?.node?.altText || finaldata?.title || ""}
                title={finaldata?.title || ""}
                width="1920"
                height="532"
                loading="eager"
                fetchpriority="high"
                decoding="sync"
                class="banner-image"
                style="aspect-ratio: 1920 / 532; object-fit: cover;"
            />
            <div class="container">
                <div class="allabout-banner">
                    <h1 class="fs-80">{finaldata?.title || ""}</h1>
                </div>
            </div>
        </section>

        <section class="property-sec">
            <div class="container">
                <div class="property-holders">
                    <h2 class="fs-60">
                        {cedarData?.propertyTitle || ""}
                    </h2>
                    <div set:html={cedarData?.descrptionmain || ""} />
                </div>
            </div>
        </section>

        <section class="popular-sec">
            <img
                src="/overlay-image-2.png"
                alt=""
                width="1920"
                height="466"
                loading="lazy"
                decoding="async"
                class="overlays-image"
            />
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="choose-holders">
                            <h3 class="fs-40">
                                {cedarData?.mainTitlegreen || ""}
                            </h3>
                            <div
                                class="edior-data"
                                set:html={cedarData?.greendescription || ""}
                            />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="image-popular">
                            <img
                                src={cedarData?.greenimage?.node?.mediaItemUrl || ""}
                                alt={cedarData?.greenimage?.node?.altText || ""}
                                width="671"
                                height="587"
                                loading="lazy"
                                decoding="async"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="gallery-sec">
            <div class="container">
                <div class="center-data">
                    <h3 class="fs-40">{finaldata?.title || ""} Gallery</h3>
                </div>
                <div class="gallery-grids">
                    {
                        cedarData?.galleryImage?.nodes?.map(
                            (image) => {
                                const largeSize = image.mediaDetails?.sizes?.find((s) => s.name === "large");
                                const finalImageUrl = largeSize?.sourceUrl || image.sourceUrl;
                                
                                return (
                                    <div class="gallery-image">
                                        <a href={finalImageUrl} class="glightbox" data-gallery="fence-gallery">
                                            <img
                                                src={finalImageUrl}
                                                loading="lazy"
                                                decoding="async"
                                                width={largeSize?.width || "1024"}
                                                height={largeSize?.height || "576"}
                                                alt={image.altText || "Gallery Image"}
                                            />
                                        </a>
                                    </div>
                                );
                            },
                        )
                    }
                </div>
            </div>
        </section>

        <Footer />

        <style>
            .property-holders .fs-60 { width: 100%; }
            .property-sec { padding: 75px 0px; }
            .image-popular { max-width: 671px; width: 100%; margin: 0 auto; }
            .choose-holders { max-width: 865px; width: 100%; }
            section.popular-sec {
                padding: 75px 0px; position: relative; z-index: 1;
                overflow: hidden; background: var(--color-green); color: var(--color-white);
            }
            .edior-data { padding-top: 25px; }
            .choose-holders .fs-40, .center-data .fs-40 { font-weight: 700; }
            .center-data { max-width: fit-content; margin: 0 auto; width: 100%; text-align: center; }
            .gallery-image { height: 305px; overflow: hidden; max-width: 388px; width: 100%; margin: 0 auto; }
            .gallery-image img { height: 100%; width: 100%; object-fit: cover; object-position: center; }
            .gallery-grids { display: grid; gap: 10px; grid-template-columns: repeat(4, minmax(0, 1fr)); padding-top: 70px; }
            .gallery-image a { display: block; height: 100%; width: 100%; }
            .gallery-grids .gallery-image:nth-child(1) { grid-column: span 2; grid-row: span 2; height: 626px; width: 100%; max-width: 100%; }
            section.gallery-sec { padding: 85px 0px; }
            @media (max-width: 1600px) {
                section.property-sec, section.popular-sec, section.gallery-sec { padding: 60px 0px; }
                .choose-holders { max-width: 90%; }
                .gallery-grids { padding-top: 50px; }
            }
            @media (max-width: 1400px) {
                section.property-sec, section.popular-sec, section.gallery-sec { padding: 40px 0px; }
                .gallery-grids { padding-top: 30px; }
            }
            @media (max-width: 1199px) { .gallery-grids { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
            @media (max-width: 991px) {
                .gallery-grids .gallery-image:nth-child(1) { grid-column: span 1; grid-row: span 1; }
                .gallery-image, .gallery-grids .gallery-image:nth-child(1) { height: 215px; max-width: 388px; width: 100%; margin: 0 auto; }
            }
            @media (max-width: 767px) {
                .choose-holders { max-width: 100%; }
                .gallery-grids { grid-template-columns: repeat(2, minmax(0, 1fr)); }
                section.property-sec, section.popular-sec, section.gallery-sec { padding: 30px 0px; }
            }
        </style>

        {/* SPEED: Defer non-critical scripts */}
        <script is:inline src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js" defer></script>

        <script is:inline>
            function initGallery() {
                if (typeof GLightbox === 'function') {
                    const lightbox = GLightbox({
                        selector: ".glightbox",
                        touchNavigation: true,
                        loop: true
                    });
                } else {
                    // Retry if script isn't quite ready
                    setTimeout(initGallery, 100);
                }
            }
            // Use window load to ensure all resources are ready without blocking
            window.addEventListener('load', initGallery);
            document.addEventListener('astro:page-load', initGallery);
        </script>
    </body>
</html>