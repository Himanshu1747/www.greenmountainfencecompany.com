---
import { queryWordPress } from "../lib/wordpress";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";

const REVIEW_DATA = `
query Reviewpage {
  page(id: "reviews", idType: URI) {
    title
    seo {
      canonical
      cornerstone
      fullHead
    }
    featuredImage {
      node {
        mediaItemUrl
        altText
      }
    }
  }
}
`;

const pagedata = await queryWordPress(REVIEW_DATA);
const finaldata = pagedata?.page || {};
const seodata = finaldata?.seo || {};
const bannerUrl = finaldata?.featuredImage?.node?.mediaItemUrl;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead
            useYoast={true}
            canonical={seodata?.canonical || ""}
            focuskw={seodata?.focuskw || ""}
        />
        {seodata?.fullHead && <Fragment set:html={seodata.fullHead} />}
    </head>

    <body>
        <Header />

        <main>
            <section class="innerbanner-sec">
                <img
                    src={bannerUrl || ""}
                    alt={finaldata?.featuredImage?.node?.altText ||
                        finaldata?.title ||
                        ""}
                    title={finaldata?.title || ""}
                    width="1920"
                    height="532"
                    class="banner-image"
                />
                <div class="container">
                    <div class="allabout-banner">
                        <h1 class="fs-80">{finaldata?.title || ""}</h1>
                    </div>
                </div>
            </section>

            <section class="review-data">
                <div class="container">
                    <div
                        id="indexReviewsWidget"
                        data-merchant="51664"
                        data-header-adjective="satisfied"
                        data-header-noun="customers"
                        data-write-disable="false"
                    >
                    </div>
                </div>
            </section>
        </main>

        <script >
            (function () {
                function injectWidget() {
                    const container =
                        document.getElementById("indexReviewsWidget");
                    if (!container) return;

                    // Clean up previous attempts
                    const oldScript = document.getElementById(
                        "survly-script-loader",
                    );
                    if (oldScript) oldScript.remove();

                    const script = document.createElement("script");
                    script.id = "survly-script-loader";
                    // Adding a timestamp cache-buster to ensure a fresh fetch
                    script.src =
                        "https://survlywidget.firebaseapp.com/static/js/index.js?v=" +
                        new Date().getTime();
                    script.async = true;

                    script.onload = () => {
                        console.log(
                            "Survly script loaded. Attempting render...",
                        );
                        // Poll for the render function in case of slow execution
                        let attempts = 0;
                        const checkRender = setInterval(() => {
                            if (typeof window.renderApp === "function") {
                                window.renderApp();
                                clearInterval(checkRender);
                                console.log("Widget Rendered Successfully");
                            }
                            if (attempts > 20) clearInterval(checkRender); // Stop after 2 seconds
                            attempts++;
                        }, 100);
                    };

                    document.body.appendChild(script);
                }

                // Run on initial load
                if (document.readyState === "complete") {
                    injectWidget();
                } else {
                    window.addEventListener("load", injectWidget);
                }

                // Run on Astro navigation
                document.addEventListener("astro:page-load", injectWidget);
                document.addEventListener("astro:after-swap", injectWidget);
            })();
        </script>

        <style is:global>
            #indexReviewsWidget img {
                max-width: 50px !important;
                height: auto !important;
            }
            #indexReviewsWidget .review-item {
                margin-bottom: 20px;
                border-bottom: 1px solid #eee;
            }

            section.review-data {
                padding: 40px 0px;
                min-height: 600px;
            }
            .banner-image {
                width: 100%;
                height: auto;
                aspect-ratio: 1920/532;
                object-fit: cover;
            }
        </style>
    </body>
</html>
