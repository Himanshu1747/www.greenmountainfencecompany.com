---
import BaseHead from "../components/BaseHead.astro";
import { queryWordPress } from "../lib/wordpress";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Testimonial from "../components/Testimonial.astro";
import EstimateForm from "../components/EstimateForm.astro";

/** * HIGH SPEED CACHING STRATEGY
 * public, s-maxage=1, stale-while-revalidate=59
 * This ensures 0ms delivery from the edge while keeping data fresh.
 */
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=120, stale-while-revalidate=30'
);

const PAGEQUERY=`
query Estimatespage {
  page(id: "request-a-free-estimate-form", idType: URI) {
    title
     seo {
       canonical
       cornerstone
       fullHead
     }
    featuredImage {
      node {
        mediaItemUrl
        altText
      }
    }
  }
}
`

const pagedata = await queryWordPress(PAGEQUERY);
const finaldata = pagedata?.page || {};
const seodata = finaldata?.seo || {};
const bannerUrl = finaldata?.featuredImage?.node?.mediaItemUrl || "";
---

<!doctype html>
<html lang="en">
    <head>
          <BaseHead
            useYoast={true}
            canonical={seodata?.canonical || ""}
            focuskw={seodata?.focuskw || ""}
        />
        {seodata?.fullHead && <Fragment set:html={seodata.fullHead} />}
        
        {/* SPEED: Preload the main banner image immediately */}
        {bannerUrl && (
            <link rel="preload" as="image" href={bannerUrl} fetchpriority="high" />
        )}
    </head>
    <body>
        <Header />

        <section class="innerbanner-sec">
            <img
                src={bannerUrl}
                alt={finaldata?.featuredImage?.node?.altText || finaldata?.title || ""}
                width="1920"
                height="532"
                loading="eager"
                fetchpriority="high"
                decoding="sync"
                class="banner-image"
                style="aspect-ratio: 1920 / 532; object-fit: cover;"
            />
            <div class="container">
                <div class="allabout-banner">
                    <h1 class="fs-80">{finaldata?.title || ""}</h1>
                </div>
            </div>
        </section>

        <section class="contact-sec estimate">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-12">
                        <div class="main-formholders">
                             {/* SPEED: Form is priority on this page */}
                             <EstimateForm />
                        </div>
                    </div>
                </div>
            </div>
        </section>

        {/* SPEED: Hydrate Testimonial only when visible */}
         <Testimonial client:visible />

        <Footer />

        <style>
            /* Layout Stability */
            .banner-image { width: 100%; height: auto; display: block; }

            .details-holders {
                max-width: 365px;
                width: 100%;
                text-align: center;
            }
            .icon-image {
                max-width: fit-content;
                margin: 0 auto 20px;
            }
            .center-data {
                max-width: fit-content;
                margin: 0 auto;
                text-align: center;
                width: 100%;
            }
            .grid-details {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                column-gap: 30px;
                row-gap: 30px;
                padding-top: 75px;
            }
            section.getconnect-sec {
                padding: 75px 0px;
            }
            .details-holders a {
                word-break: break-word;
                overflow-wrap: break-word;
            }
            section.contact-sec {
                position: relative;
                z-index: 1;
                width: 100%;
                overflow: hidden;
                color: var(--color-white);
                padding: 55px 0px;
            }
            section.contact-sec .banner-image {
                filter: brightness(0.5);
            }
            .about-contact {
                max-width: 587px;
                width: 100%;
            }
            @media (max-width: 1600px) {
                .icon-image {
                    max-width: 40px;
                }
                .details-holders {
                    max-width: 295px;
                }
                section.getconnect-sec {
                    padding: 60px 0px;
                }
                .grid-details {
                    padding-top: 50px;
                }
            }
            @media (max-width: 1400px) {
                section.getconnect-sec {
                    padding: 40px 0px;
                }
                .grid-details {
                    padding-top: 30px;
                    gap: 30px;
                }
                section.contact-sec {
                    padding: 40px 0px;
                }
            }
            @media (max-width: 991px) {
                .about-contact {
                    text-align: center;
                    max-width: 100%;
                    margin: 0 auto;
                }
            }
        </style>
    </body>
</html>