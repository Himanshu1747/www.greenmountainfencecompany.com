---
// src/pages/blog/[slug].astro
import { queryWordPress } from "../../lib/wordpress";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

export async function getStaticPaths() {
    const SLUGS_QUERY = `
    query GetSlugs {
      posts(first: 100) {
        nodes {
          slug
        }
      }
    }`;
    const data = await queryWordPress(SLUGS_QUERY);
    return data.posts.nodes.map((post: any) => ({
        params: { slug: post.slug },
    }));
}

const { slug } = Astro.params;

const DATA_QUERY = `
query GetPostAndRecent($id: ID!) {
  post(id: $id, idType: SLUG) {
    title
    content
    excerpt
    featuredImage {
      node {
        mediaItemUrl
      }
    }
  }
  posts(first: 3) {
    nodes {
      slug
      title
      date
      excerpt
      featuredImage {
        node {
          mediaItemUrl
        }
      }
    }
  }
}`;

const response = await queryWordPress(DATA_QUERY, { id: slug });
const post = response.post;
const recentBlogs = response.posts.nodes;

if (!post) {
    return Astro.redirect("/404");
}

const cleanDescription = post.excerpt 
    ? post.excerpt.replace(/<[^>]*>?/gm, '').trim() 
    : "";

const bannerUrl = post.featuredImage?.node?.mediaItemUrl || "/placeholder.jpg";
---

<html lang="en">
    <head>
        <BaseHead title={post.title} description={cleanDescription} />
        <link rel="preload" as="image" href={bannerUrl} />
    </head>
    <body>
        <Header />

        <section class="innerbanner-sec">
            <img
                src={bannerUrl}
                alt={post.title || "Blog Image"}
                title={post.title}
                width="1920"
                height="532"
                class="banner-image"
                loading="eager" 
                fetchpriority="high"
            />
            <div class="container">
                <div class="allabout-banner">
                    <h1 class="fs-80">{post.title}</h1>
                </div>
            </div>
        </section>

        <section class="alldatahere-sec">
            <div class="container">
                <div class="gridnavmini">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item"><a href="/blog">Blogs</a></li>
                            <li class="breadcrumb-item active" aria-current="page">
                                <a href="javascript:void(0)">{post.title}</a>
                            </li>
                        </ol>
                    </nav>
                    <div class="share-articles">
                        <p>Share this article</p>
                        <ul class="sharelinks">
                            <li>
                                <a href="javascript:void(0)" class="native-share-btn" data-title={post.title}>
                                    <img src="/share-icon.png" alt="share" height="25" width="25" loading="lazy" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/li.png" alt="linkedin" height="25" width="25" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/fb.png" alt="facebook" height="25" width="25" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/twiter.png" alt="twitter" height="25" width="25" />
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="post-content" set:html={post.content} />

                <div class="bootm-hereee">
                    <div class="share-articles">
                        <p>Share this article</p>
                        <ul class="sharelinks">
                            <li>
                                <a href="javascript:void(0)" class="native-share-btn" data-title={post.title}>
                                    <img src="/share-icon.png" alt="share" height="25" width="25" loading="lazy" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/li.png" alt="linkedin" height="25" width="25" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/fb.png" alt="facebook" height="25" width="25" />
                                </a>
                            </li>
                            <li>
                                <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url)}`} target="_blank" rel="noopener">
                                    <img src="/twiter.png" alt="twitter" height="25" width="25" />
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="recentblogs">
            <img src="/bg-3.png" alt="" width="1920" height="466" loading="lazy" class="overlays-image" />
            <div class="container">
                <div class="center-data">
                    <h4 class="fs-60 text-green">Our Recent Blogs</h4>
                </div>
                <div class="blog-grids">
                    {recentBlogs.map((blogitems) => (
                        <div class="blog-holders">
                            <a href={`/blog/${blogitems.slug}`} title={blogitems.title}>
                                <div class="main-ima">
                                    <img 
                                        src={blogitems?.featuredImage?.node?.mediaItemUrl || "/placeholder.jpg"} 
                                        alt={blogitems.title} 
                                        height="347" width="495" loading="lazy" 
                                    />
                                </div>
                            </a>
                            <div class="bootm-data">
                                <p class="date">
                                    {blogitems?.date ? new Date(blogitems.date).toLocaleDateString("en-GB") : ""}
                                </p>
                                <h6 class="fs-20">{blogitems.title}</h6>
                                <div set:html={blogitems.excerpt} />
                                <div class="grid-readmore">
                                    <div class="read-button">
                                        <a href={`/blog/${blogitems.slug}`}>Read More Â»</a>
                                    </div>
                                    <div 
                                        class="sharenow native-share-btn" 
                                        style="cursor: pointer;" 
                                        data-title={blogitems.title} 
                                        data-url={`/blog/${blogitems.slug}`}
                                    >
                                        <img src="/share-icon.png" alt="share" height="20" width="20" loading="lazy" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </section>

        <Footer />

        <style>
            /* Your existing CSS (Unchanged as requested) */
            .gridnavmini a { font-size: 14px; line-height: 20px; font-weight: 400; }
            .gridnavmini li.breadcrumb-item.active a { font-weight: 500; color: var(--color-black); }
            .post-content a { text-decoration: underline; }
            .gridnavmini { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; justify-content: space-between; padding-bottom: 50px; }
            ul.sharelinks, .share-articles { align-items: center; display: flex; gap: 10px; }
            .share-articles p { padding-bottom: 0; color: rgba(0, 0, 0, 0.6); font-size: 14px; }
            .bootm-hereee .share-articles { flex-direction: column-reverse; justify-content: center; padding-top: 65px; }
            section.alldatahere-sec { padding: 50px 0px; }
            section.recentblogs { padding: 60px 0px 100px 0px; background: #fff5f5; position: relative; z-index: 1; }
            .center-data { text-align: center; padding-bottom: 30px; }
            @media(max-width:1600px){ section.recentblogs { padding:60px 0px; } }
            @media (max-width: 1400px) { .gridnavmini { padding-bottom: 30px; } section.recentblogs { padding:50px 0px; } }
            @media (max-width: 767px) { section.alldatahere-sec { padding: 30px 0px; } section.recentblogs { padding:40px 0px; } }
        </style>

        <script>
            const initShare = () => {
                const shareBtns = document.querySelectorAll(".native-share-btn");
                shareBtns.forEach((btn) => {
                    btn.addEventListener("click", async (e) => {
                        e.preventDefault();
                        const title = btn.getAttribute("data-title");
                        const relativeUrl = btn.getAttribute("data-url");
                        const url = relativeUrl 
                            ? window.location.origin + relativeUrl 
                            : window.location.href;

                        if (navigator.share) {
                            try {
                                await navigator.share({
                                    title: title,
                                    text: `Check out this article: ${title}`,
                                    url: url,
                                });
                            } catch (err) {
                                if (err.name !== "AbortError") console.error("Error sharing:", err);
                            }
                        } else {
                            try {
                                await navigator.clipboard.writeText(url);
                                alert("Link copied to clipboard!");
                            } catch (err) {
                                console.error("Failed to copy: ", err);
                            }
                        }
                    });
                });
            };

            initShare();
            document.addEventListener('astro:after-swap', initShare);
        </script>
    </body>
</html>