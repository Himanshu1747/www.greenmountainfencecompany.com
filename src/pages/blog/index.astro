---
import { queryWordPress } from "../../lib/wordpress";
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";

/** * SPEED OPTIMIZATION: 
 * Combined parallel fetching for all page and blog data.
 */
const BLOGQUERY = `
query blogpage{
   page(id: "blog", idType: URI){
    title
     seo {
      canonical
      cornerstone
      fullHead
    }
     featuredImage {
      node {
        mediaItemUrl
        altText
      }
    }
  }
}
`;

const MAIN_BLOGDATA = `
query MainBlog {
  posts(first: 100) {
    nodes {
      id
      title
      slug
      excerpt
      date
      featuredImage {
        node {
          mediaItemUrl
          altText
        }
      }
    }
  }
}
`;

const [pagedata, allblogpost] = await Promise.all([
    queryWordPress(BLOGQUERY),
    queryWordPress(MAIN_BLOGDATA)
]);

const finaldata = pagedata?.page || {};
const seodata = finaldata?.seo || {};
const alldatahere = allblogpost?.posts?.nodes || [];

const bannerUrl = finaldata?.featuredImage?.node?.mediaItemUrl;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead
            useYoast={true}
            canonical={seodata?.canonical || ""}
            focuskw={seodata?.focuskw || ""}
        />
        {seodata?.fullHead && <Fragment set:html={seodata.fullHead} />}

        {bannerUrl && (
            <link rel="preload" as="image" href={bannerUrl} fetchpriority="high" />
        )}
    </head>
    <body>
        <Header />
        
        <section class="innerbanner-sec">
            <img
                src={bannerUrl || "/fallback.jpg"}
                alt={finaldata?.title || "Blog"}
                title={finaldata?.title || "Blog"}
                width="1920"
                height="532"
                /* 2. PRIORITY LOADING */
                loading="eager"
                fetchpriority="high"
                decoding="sync"
                class="banner-image"
            />
            <div class="container">
                <div class="allabout-banner">
                    <h1 class="fs-80">{finaldata?.title || "Blog"}</h1>
                </div>
            </div>
        </section>

        <section class="blogmain-sec">
            <div class="container">
                <div class="grid-topblo">
                    <div class="title-blogsss">
                        <h2 class="fs-40 text-green">
                            Green Mountain Fence Blogs
                        </h2>
                    </div>
                    <div class="serach-filters">
                        <div class="inputfilters">
                            <input
                                type="text"
                                id="blogSearch"
                                placeholder="search"
                            />
                            <button aria-label="Search">
                                <img
                                    src="/search.png"
                                    alt=""
                                    height="20"
                                    width="20"
                                    loading="lazy"
                                />
                            </button>
                        </div>
                        <div
                            class="clearall"
                            id="clearSearch"
                            style="cursor: pointer;"
                        >
                            <p>
                                Clear <img
                                    src="/clear.png"
                                    alt="clear"
                                    height="20"
                                    width="20"
                                    loading="lazy"
                                />
                            </p>
                        </div>
                    </div>
                </div>

                <div class="blog-grids" id="blogContainer">
                    {
                        alldatahere.map((blogitems, index) => {
                            const postImg = blogitems?.featuredImage?.node?.mediaItemUrl;
                            return (
                                <div
                                    class="blog-holders"
                                    data-title={blogitems.title?.toLowerCase()}
                                    data-content={blogitems.excerpt?.toLowerCase()}
                                >
                                    <a
                                        href={`/blog/${blogitems.slug}`}
                                        title={blogitems.title || ""}
                                    >
                                        <div class="main-ima">
                                            <img
                                                src={postImg || "/placeholder.jpg"}
                                                alt={blogitems.title || ""}
                                                height="347"
                                                width="495"
                                                /* Lazy load everything except top 3 posts */
                                                loading={index < 3 ? "eager" : "lazy"}
                                                decoding="async"
                                            />
                                        </div>
                                    </a>
                                    <div class="bootm-data">
                                        <p class="date">
                                            {blogitems?.date
                                                ? new Date(blogitems.date).toLocaleDateString("en-GB")
                                                : ""}
                                        </p>
                                        <h6 class="fs-20">
                                            {blogitems.title || ""}
                                        </h6>
                                        <div set:html={blogitems?.excerpt || ""} />
                                        <div class="grid-readmore">
                                            <div class="read-button">
                                                <a href={`/blog/${blogitems.slug}`}>
                                                    Read More Â»
                                                </a>
                                            </div>
                                            <div
                                                class="sharenow share-button"
                                                style="cursor: pointer;"
                                                data-title={blogitems.title}
                                                data-url={`/blog/${blogitems.slug}`}
                                            >
                                                <img
                                                    src="/share-icon.png"
                                                    alt="share"
                                                    height="20"
                                                    width="20"
                                                    loading="lazy"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    }
                </div>
                <div
                    id="noResults"
                    style="display: none; text-align: center; padding: 50px;"
                >
                    <p>No blogs found matching your search.</p>
                </div>
            </div>
        </section>

        <Footer />

		<style>
			.inputfilters input {
				border: none;
			}

			.inputfilters button {
				background: transparent;
				border: none;
				max-width: 25px;
				width: 25px;
				padding: 0;
			}
			.inputfilters {
				display: flex;
				max-width: 200px;
				width: 100%;
				border: 1px solid var(--color-black);
				padding: 5px 10px;
			}

			.serach-filters {
				display: flex;
				align-items: center;
				gap: 20px;
			}

			.serach-filters p {
				padding: 0;
			}

			.grid-topblo {
				display: flex;
				justify-content: space-between;
				gap: 20px;
				flex-wrap: wrap;
				padding-bottom: 70px;
			}
			section.blogmain-sec {
				padding: 75px 0px;
			}

			.inputfilters img {
				height: 20px;
				width: 20px;
			}
			@media (max-width: 1600px) {
				section.blogmain-sec {
					padding: 60px 0px;
				}
				.grid-topblo {
					padding-bottom: 50px;
				}
			}
			@media (max-width: 1199px) {
				section.blogmain-sec {
					padding: 50px 0px;
				}
			}
			@media (max-width: 991px) {
				.grid-topblo {
					padding-bottom: 40px;
					flex-direction: column;
				}
			}
		
		</style>

		<script>
			const shareButtons = document.querySelectorAll(".share-button");

			shareButtons.forEach((button) => {
				button.addEventListener("click", async () => {
					const title = button.getAttribute("data-title");
					const url =
						window.location.origin +
						button.getAttribute("data-url");

					if (navigator.share) {
						try {
							await navigator.share({
								title: title,
								text: `Check this out: ${title}`,
								url: url,
							});
							console.log("Shared successfully");
						} catch (err) {
							console.log("Error sharing:", err);
						}
					} else {
						try {
							await navigator.clipboard.writeText(url);
							alert("Link copied to clipboard!");
						} catch (err) {
							console.error("Failed to copy: ", err);
						}
					}
				});
			});

			// Elements
			const searchInput = document.getElementById(
				"blogSearch",
			) as HTMLInputElement;
			const clearBtn = document.getElementById("clearSearch");
			const blogCards = document.querySelectorAll(".blog-holders");
			const noResults = document.getElementById("noResults");

			function filterBlogs() {
				const searchTerm = searchInput.value.toLowerCase().trim();
				let hasVisibleCards = false;

				blogCards.forEach((card) => {
					const title = card.getAttribute("data-title") || "";
					const content = card.getAttribute("data-content") || "";
					if (
						title.includes(searchTerm) ||
						content.includes(searchTerm)
					) {
						(card as HTMLElement).style.display = "block";
						hasVisibleCards = true;
					} else {
						(card as HTMLElement).style.display = "none";
					}
				});
				if (noResults) {
					noResults.style.display = hasVisibleCards
						? "none"
						: "block";
				}
			}
			searchInput?.addEventListener("input", filterBlogs);

			clearBtn?.addEventListener("click", () => {
				if (searchInput) {
					searchInput.value = "";
					filterBlogs();
				}
			});
		</script>
	</body>
</html>
