---
import HeaderLink from "./HeaderLink.astro";
import { queryWordPress } from "../lib/wordpress";

const QUERY_MENU = `
query MainMenu {
  menu(id: "mainmenu", idType: SLUG) {
    menuItems(first: 100) {
      nodes {
        label
        uri
        target
        order
        parentId
        cssClasses
        childItems(first: 20) {
          nodes {
            label
            uri
            target
            order
          }
        }
      }
    }
  }
  siteLogo {
    sourceUrl
    altText
  }
}
`;

const data = await queryWordPress(QUERY_MENU);
const logo = data?.siteLogo?.sourceUrl;
const rawNodes = data?.menu?.menuItems?.nodes || [];

// Pre-process menu items once outside the template
const menuItems = rawNodes
    .filter((item) => !item.parentId)
    .sort((a, b) => (a.order || 0) - (b.order || 0))
    .map((item) => ({
        label: item.label,
        uri: item.uri.replace(/\/$/, ""),
        target: item.target,
        cssClasses: item.cssClasses?.join(" ") || "",
        children: (item.childItems?.nodes || [])
            .sort((a, b) => (a.order || 0) - (b.order || 0))
            .map(child => ({
                ...child,
                uri: child.uri.replace(/\/$/, "")
            }))
    }));
---

<header class="custom-header">
    <div class="top-headers">
        <div class="container">
            <div class="grids-data">
                <div class="details-data">
                    <p>
                        <a href="tel:+18602920340">Contact No.: (860) 292-0340</a>
                    </p>
                </div>
                <div class="details-data">
                    <p><a href="#">Get Your Free Estimate Today</a></p>
                </div>
            </div>
        </div>
    </div>
    <div class="main-headers">
        <div class="container">
            <div class="grid-headers">
                <div class="grid-mobiles">
                    <div class="main_logo">
                        <HeaderLink href="/" title="Home">
                            <img
                                src={logo}
                                alt={data?.siteLogo?.altText || "Logo"}
                                width="200"
                                height="77"
                                loading="eager"
                                fetchpriority="high"
                                decoding="async"
                            />
                        </HeaderLink>
                    </div>
                    <div class="menu-icon" aria-label="Toggle Menu">
                        <svg class="bars" viewBox="0 0 100 100" onclick="this.classList.toggle('active')">
                            <path class="line top" d="m 30,33 h 40 c 13.100415,0 14.380204,31.80258 6.899646,33.421777 -24.612039,5.327373 9.016154,-52.337577 -12.75751,-30.563913 l -28.284272,28.284272"></path>
                            <path class="line middle" d="m 70,50 c 0,0 -32.213436,0 -40,0 -7.786564,0 -6.428571,-4.640244 -6.428571,-8.571429 0,-5.895471 6.073743,-11.783399 12.286435,-5.570707 6.212692,6.212692 28.284272,28.284272 28.284272,28.284272"></path>
                            <path class="line bottom" d="m 69.575405,67.073826 h -40 c -13.100415,0 -14.380204,-31.80258 -6.899646,-33.421777 24.612039,-5.327373 -9.016154,52.337577 12.75751,30.563913 l 28.284272,-28.284272"></path>
                        </svg>
                    </div>
                </div>
                <nav class="header-linksgrids">
                    <ul class="list_data">
                        {menuItems.map((item) => (
                            <li class={`${item.cssClasses} ${item.children.length ? "menu-item-has-children" : ""}`.trim()}>
                                <HeaderLink href={item.uri} title={item.label} target={item.target}>
                                    {item.label}
                                </HeaderLink>
                                {item.children.length > 0 && (
                                    <ul class="sub-menu">
                                        {item.children.map((child) => (
                                            <li>
                                                <HeaderLink href={child.uri} title={child.label} target={child.target}>
                                                    {child.label}
                                                </HeaderLink>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </li>
                        ))}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>
<div class="margin-top"></div>

<style>
    header.custom-header {
        color: var(--color-white);
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 111;
    }
    .grids-data {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
    }
    .top-headers {
        background: var(--color-231F20);
        padding: 10px 0px;
    }
    .details-data p { padding: 0; }
    .main-headers {
        background: rgba(11, 11, 11, 0.2);
        backdrop-filter: blur(5px);
        padding: 15px 0px;
    }
    ul.sub-menu li {
        padding: 10px 15px;
        border-bottom: 1px solid var(--color-D3D3D3);
        background: rgba(255, 255, 255, 0.95);
    }
    header.custom-header ul.sub-menu li a {
        color: var(--color-231F20);
        font-size: 16px;
        font-weight: 500;
    }
    .details-data p a { font-size: 18px; font-weight: 500; }
    .main_logo { max-width: 200px; width: 100%; }
    .grid-headers {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 30px;
        width: 100%;
    }
    ul.list_data { display: flex; align-items: center; gap: 30px; }
    ul.list_data li a { font-size: 21px; font-weight: 500; }
    li.menu-item-has-children { position: relative; padding-right: 20px; }
    li.menu-item-has-children::after {
        position: absolute;
        top: 50%;
        right: 0;
        width: 8px;
        height: 8px;
        border-right: 2px solid var(--color-white);
        border-bottom: 2px solid var(--color-white);
        transform: translateY(-70%) rotate(45deg);
        content: "";
        pointer-events: none;
    }
    ul.sub-menu {
        position: absolute;
        width: 240px;
        top: 100%;
        left: -15%;
        display: none;
        padding-top: 10px;
    }
    .bars { width: 60px; cursor: pointer; }
    .bars .line {
        fill: none;
        stroke: var(--color-white);
        stroke-width: 4;
        transition: stroke-dasharray 400ms, stroke-dashoffset 400ms;
    }
    .bars .line.top { stroke-dasharray: 40 172; }
    .bars .line.middle { stroke-dasharray: 40 111; }
    .bars .line.bottom { stroke-dasharray: 40 172; }
    .bars.active .top { stroke-dashoffset: -132px; }
    .bars.active .middle { stroke-dashoffset: -71px; }
    .bars.active .bottom { stroke-dashoffset: -132px; }
    .menu-icon { display: none; }
    li.last-child a {
        color: var(--color-231F20);
        font-size: 18px;
        background: var(--color-white);
        padding: 10px 25px;
        border-radius: 25px;
        transition: 0.3s;
    }
    li.last-child a:hover { background: var(--color-green); color: var(--color-white) !important; }
    .margin-top { display: none; }

    @media (min-width: 1200px) {
        li.menu-item-has-children:hover ul.sub-menu { display: block !important; }
    }
    @media (max-width: 1199px) {
        .grid-headers { flex-direction: column; align-items: start; }
        .menu-icon { display: block; }
        .header-linksgrids { display: none; width: 100%; }
        .grid-mobiles { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        ul.list_data { flex-direction: column; gap: 15px; width: 100%; padding: 20px 0; }
        ul.sub-menu { position: static; width: 100%; }
        .margin-top { display: block; margin-top: 106px; }
    }
</style>

<script is:inline>
    // Pure JS for Menu Toggle (Faster than waiting for jQuery)
    document.addEventListener("DOMContentLoaded", function () {
        const menuIcon = document.querySelector(".menu-icon");
        const nav = document.querySelector(".header-linksgrids");
        
        if (menuIcon && nav) {
            menuIcon.onclick = () => {
                const isVisible = nav.style.display === "block";
                nav.style.display = isVisible ? "none" : "block";
            };
        }

        // Handle Sub-menus on mobile
        document.querySelectorAll(".menu-item-has-children").forEach(item => {
            item.onclick = function(e) {
                if (window.innerWidth < 1200) {
                    const sub = this.querySelector(".sub-menu");
                    if (sub) {
                        const isOpened = sub.style.display === "block";
                        sub.style.display = isOpened ? "none" : "block";
                    }
                }
            };
        });
    });
</script>