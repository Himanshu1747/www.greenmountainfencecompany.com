---
import { queryWordPress } from "../lib/wordpress";

const QUERY_HOMESLIDER = `
query GetHomeSliders {
  homeSliders(first: 5) {
    nodes {
      id
      featuredImage {
        node {
          sourceUrl
        }
      }
    }
  }
}
`;

const HOMEDATA = `
query Homepage {
  page(id: "/", idType: URI) {
    id
    homepage {
      excellenceTitle
    }
  }
}
`;

// Fetch data in parallel
const [datasliders, homdata] = await Promise.all([
    queryWordPress(QUERY_HOMESLIDER),
    queryWordPress(HOMEDATA)
]);

const nodes = datasliders?.homeSliders?.nodes || [];
const finaldata = homdata?.page?.homepage;

// Extract images for head preloading
const imageToPreload = nodes.map(n => n.featuredImage?.node?.sourceUrl).filter(Boolean);
---

{imageToPreload.map((url, index) => (
    <link 
        rel="preload" 
        as="image" 
        href={url} 
        fetchpriority={index === 0 ? "high" : "low"} 
    />
))}

<section class="homeslider-sec">
    <div class="container">
        <div class="content-main">
            <h1 class="fs-92 text-uppercase">{finaldata?.excellenceTitle || "error"} </h1>
            <div class="arrow-icon">
                <a href="#" title="View More" class="link-button">
                    <span>View More</span>
                    <img
                        src="/right-icon.png"
                        alt=""
                        height="20"
                        width="20"
                        loading="eager"
                    />
                </a>
            </div>
        </div>
    </div>
    <div class="silder-holde">
        <div class="swiper mySwiperhomesliders">
            <div class="swiper-wrapper">
                {
                    nodes.map((slide, index) => {
                        const imagepath = slide.featuredImage?.node?.sourceUrl;
                        return (
                            <div class="swiper-slide">
                                <div class="slider-image">
                                    <img
                                        src={imagepath || "/placeholder.jpg"}
                                        alt="Fence Excellence"
                                        width="1920"
                                        height="929"
                                        /* 2. PRIORITY CONTROL: Eager for first, lazy for others */
                                        loading={index === 0 ? "eager" : "lazy"}
                                        fetchpriority={index === 0 ? "high" : "low"}
                                        decoding={index === 0 ? "sync" : "async"}
                                    />
                                </div>
                            </div>
                        );
                    })
                }
            </div>
        </div>
    </div>
</section>

<style>
    /* 3. ASPECT RATIO: Prevents Layout Shift (CLS) */
    .slider-image {
        aspect-ratio: 1920 / 929;
        height: auto; 
        width: 100%;
        overflow: hidden;
        background: #f0f0f0;
    }

    .slider-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        object-position: center;
    }

    section.homeslider-sec {
        position: relative;
    }

    .content-main {
        position: absolute;
        top: 50%;
        z-index: 11;
        max-width: 50%;
        transform: translate(-0%, -40%);
        width: 100%;
    }

    .content-main .fs-92 {
        color: var(--color-green);
        text-shadow:
            2px 0 0 var(--color-white),
            -2px 0 0 var(--color-white),
            0 2px 0 var(--color-white),
            0 -2px 0 var(--color-white);
    }

    /* Keep your media queries for responsive heights */
    @media (max-width: 1600px) {
        .slider-image { height: 697px; aspect-ratio: auto; }
        .content-main { transform: translate(-0%, -38%); }
    }
    @media (max-width: 1400px) {
        .slider-image { height: 640px; }
    }
    @media (max-width: 1199px) {
        .content-main {
            max-width: 767px;
            text-align: center;
            margin: 0 auto;
            width: 95%;
            transform: translate(-50%, -38%);
            left: 50%;
        }
        .content-main .arrow-icon {
            max-width: fit-content;
            margin: 0 auto;
        }
    }
</style>

<script is:inline>
    // 4. SMART INITIALIZATION
    function initSwiper() {
        if (typeof Swiper !== 'undefined') {
            // Using requestAnimationFrame ensures the browser paints the UI 
            // before the heavy Swiper JS logic runs.
            requestAnimationFrame(() => {
                new Swiper(".mySwiperhomesliders", {
                    autoplay: { delay: 5000, disableOnInteraction: false },
                    effect: "fade",
                    speed: 1500,
                    loop: true,
                    fadeEffect: { crossFade: true },
                    watchSlidesProgress: true,
                    preloadImages: false, // Browser already preloaded these via HTML
                });
            });
        } else {
            setTimeout(initSwiper, 50);
        }
    }
    initSwiper();
</script>