---
import { queryWordPress } from "../lib/wordpress";

const QUERY_HOMESLIDER = `
query GetHomeSliders {
  homeSliders (first:10){
    nodes {
      id
      title
      featuredImage {
        node {
          sourceUrl
        }
      }
      homeslidermain{
        mobileBanner{
          node{
            mediaItemUrl
            altText
          }
        }
      }
    }
  }
}
`;

const HOMEDATA = `
query Homepage {
  page(id: "/", idType: URI) {
    id
    homepage {
    bannerTitle
      excellenceTitle
    }
  }
}
`;

const [datasliders, homdata] = await Promise.all([
    queryWordPress(QUERY_HOMESLIDER),
    queryWordPress(HOMEDATA),
]);

const nodes = datasliders?.homeSliders?.nodes || [];
const finaldata = homdata?.page?.homepage;
const firstSlide = nodes[0];
const preloadDesktop = firstSlide?.featuredImage?.node?.sourceUrl;
const preloadMobile = firstSlide?.homeslidermain?.mobileBanner?.node?.mediaItemUrl;
---

{/* OPTIMIZATION: High-priority Preloads with specific Media Queries */}
{preloadDesktop && (
    <link
        rel="preload"
        as="image"
        href={preloadDesktop}
        media="(min-width: 607px)"
        fetchpriority="high"
    />
)}

{preloadMobile && (
    <link
        rel="preload"
        as="image"
        href={preloadMobile}
        media="(max-width: 606px)"
        fetchpriority="high"
    />
)}

<section class="homeslider-sec">
    <div class="container">
        <div class="content-main">
            <h1 class="fs-92 text-uppercase">
                {finaldata?.bannerTitle || "error"}
            </h1>
            <div class="arrow-icon">
                <a href="/about/" title="View More" class="link-button">
                    <span>View More</span>
                    <img
                        src="/right-icon.png"
                        alt=""
                        height="20"
                        width="20"
                        loading="eager"
                        fetchpriority="high" 
                    />
                </a>
            </div>
        </div>
    </div>
    <div class="silder-holde">
        <div class="swiper mySwiperhomesliders">
            <div class="swiper-wrapper">
                {
                    nodes.map((slide, index) => {
                        const imagepath = slide.featuredImage?.node?.sourceUrl;
                        const mobilepath = slide.homeslidermain?.mobileBanner?.node?.mediaItemUrl;
                        const altText = slide.homeslidermain?.mobileBanner?.node?.altText || "Fence Excellence";
                        const isFirst = index === 0;

                        return (
                            <div class="swiper-slide" key={slide.id}>
                                <div class="slider-image">
                                    <picture>
                                        {mobilepath && (
                                            <source
                                                media="(max-width: 606px)"
                                                srcset={mobilepath}
                                            />
                                        )}
                                        <img
                                            src={imagepath || "/placeholder.jpg"}
                                            alt={altText}
                                            width="1920"
                                            height="929"
                                            /* OPTIMIZATION: Critical image attributes for LCP */
                                            loading={isFirst ? "eager" : "lazy"}
                                            fetchpriority={isFirst ? "high" : "low"}
                                            decoding={isFirst ? "sync" : "async"}
                                        />
                                    </picture>
                                </div>
                            </div>
                        );
                    })
                }
            </div>
        </div>
    </div>
</section>

<style>
    /* OPTIMIZATION: contain: layout prevents the slider from shifting other elements */
    section.homeslider-sec {
        position: relative;
        contain: layout;
    }

    .slider-image {
        aspect-ratio: 1920 / 929;
        height: auto;
        width: 100%;
        overflow: hidden;
        background: #f0f0f0; /* Visual placeholder while loading */
    }

    .slider-image img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        object-position: center;
    }

    .content-main {
        position: absolute;
        top: 50%;
        z-index: 11;
        max-width: 45%;
        transform: translate(-0%, -40%);
        width: 100%;
    }

    .content-main .fs-92 {
        color: var(--color-green);
        text-shadow:
            2px 0 0 var(--color-white),
            -2px 0 0 var(--color-white),
            0 2px 0 var(--color-white),
            0 -2px 0 var(--color-white);
    }

    @media (max-width: 1600px) {
        .slider-image {
            height: 697px;
            aspect-ratio: auto;
        }
        .content-main {
            max-width: 42%;
            transform: translate(-0%, -38%);
        }
    }
    @media (max-width: 1400px) {
        .slider-image {
            height: 640px;
        }
        .content-main {
            max-width: 40%;
        }
    }
    @media (max-width: 1199px) {
        .content-main {
            max-width: 100%;
            text-align: center;
            margin: 0 auto;
            width: 95%;
            transform: translate(-50%, -38%);
            left: 50%;
        }
        .content-main .arrow-icon {
            max-width: fit-content;
            margin: 0 auto;
        }
    }
</style>

<script is:inline>
    // OPTIMIZATION: Initialize Swiper after the first frame to allow LCP image to paint first
    function initSwiper() {
        if (typeof Swiper !== "undefined") {
            requestAnimationFrame(() => {
                new Swiper(".mySwiperhomesliders", {
                    autoplay: { delay: 5000, disableOnInteraction: false },
                    effect: "fade",
                    speed: 1500,
                    loop: true,
                    fadeEffect: { crossFade: true },
                    watchSlidesProgress: true,
                    preloadImages: false, // Critical: don't let Swiper block the main thread
                    lazy: true
                });
            });
        } else {
            setTimeout(initSwiper, 50);
        }
    }
    
    // Support both standard and Astro View Transitions
    document.addEventListener("DOMContentLoaded", initSwiper);
    document.addEventListener("astro:page-load", initSwiper);
</script>